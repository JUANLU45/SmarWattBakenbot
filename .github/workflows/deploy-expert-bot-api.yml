name: Deploy Expert Bot API to Cloud Run

on:
  push:
    branches:
      - master
    paths:
      - 'expert_bot_api_COPY/**'

jobs:
  deploy:
    name: Deploy Expert Bot API
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Authenticate to Google Cloud
      uses: 'google-github-actions/auth@v1'
      with:
        credentials_json: '${{ secrets.GCP_SA_KEY }}'

    - name: Deploy to Cloud Run
      run: |
        gcloud run deploy expert-bot-api \\
          --source ./expert_bot_api_COPY \\
          --platform managed \\
          --region europe-west1 \\
          --allow-unauthenticated \\
          --service-account="firebase-adminsdk-fbsvc@smatwatt.iam.gserviceaccount.com" \\
          --memory="4Gi" \\
          --cpu="2" \\
          --max-instances="5" \\
          --timeout="900s" \\
          --set-secrets='${{ secrets.EXPERT_BOT_API_SECRETS }}' \\
          --set-env-vars='${{ secrets.EXPERT_BOT_API_ENV_VARS }}'
