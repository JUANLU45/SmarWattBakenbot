# üß† DOCUMENTACI√ìN COMPLETA - SISTEMA DE INTELIGENCIA ARTIFICIAL SMARWATT

## üìã **INFORMACI√ìN GENERAL DEL SISTEMA IA**

**Nombre del Sistema:** SmarWatt AI Engine  
**Versi√≥n:** 2025.1.0 - EMPRESARIAL  
**Tecnolog√≠as:** Gemini 1.5 Flash + BigQuery ML + Python ML Libraries  
**Especializaci√≥n:** An√°lisis energ√©tico, reconocimiento de emociones, aprendizaje autom√°tico  
**Arquitectura:** Distribuida entre Expert Bot API y Energy IA API

---

## üèóÔ∏è **ARQUITECTURA DEL SISTEMA IA**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    üß† SMARWATT AI ENGINE                        ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                                 ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê               ‚îÇ
‚îÇ  ‚îÇ   EXPERT BOT    ‚îÇ         ‚îÇ   ENERGY IA     ‚îÇ               ‚îÇ
‚îÇ  ‚îÇ      API        ‚îÇ‚óÑ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∫ ‚îÇ      API        ‚îÇ               ‚îÇ
‚îÇ  ‚îÇ                 ‚îÇ         ‚îÇ                 ‚îÇ               ‚îÇ
‚îÇ  ‚îÇ üîπ AI Learning  ‚îÇ         ‚îÇ üîπ Chat Service ‚îÇ               ‚îÇ
‚îÇ  ‚îÇ üîπ User Patterns‚îÇ         ‚îÇ üîπ Sentiment    ‚îÇ               ‚îÇ
‚îÇ  ‚îÇ üîπ Predictions  ‚îÇ         ‚îÇ üîπ Gemini AI    ‚îÇ               ‚îÇ
‚îÇ  ‚îÇ üîπ ML Models    ‚îÇ         ‚îÇ üîπ Response Gen ‚îÇ               ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò               ‚îÇ
‚îÇ           ‚îÇ                           ‚îÇ                         ‚îÇ
‚îÇ           ‚ñº                           ‚ñº                         ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  ‚îÇ           üìä BIGQUERY ML ENGINE                             ‚îÇ
‚îÇ  ‚îÇ                                                             ‚îÇ
‚îÇ  ‚îÇ ‚Ä¢ ai_learning_data        ‚Ä¢ chatbot_interactions           ‚îÇ
‚îÇ  ‚îÇ ‚Ä¢ user_behavior_patterns  ‚Ä¢ sentiment_analysis             ‚îÇ
‚îÇ  ‚îÇ ‚Ä¢ ml_model_predictions    ‚Ä¢ conversation_context           ‚îÇ
‚îÇ  ‚îÇ ‚Ä¢ emotional_analytics     ‚Ä¢ user_satisfaction_metrics      ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## ü§ñ **COMPONENTES PRINCIPALES DEL SISTEMA IA**

### 1Ô∏è‚É£ **GENERATIVE CHAT SERVICE - MOTOR CONVERSACIONAL**

**Ubicaci√≥n:** `energy_ia_api_COPY/app/services/generative_chat_service.py`

#### **üß† Funcionalidades Core:**

**A) Modelo Gemini 1.5 Flash Configurado:**

```python
self.model = genai.GenerativeModel(
    model_name="gemini-1.5-flash",
    generation_config=genai.types.GenerationConfig(
        temperature=0.7,      # Creatividad controlada
        top_p=0.9,           # Diversidad de respuesta
        top_k=40,            # Vocabulario espec√≠fico
        max_output_tokens=2048,  # Respuestas detalladas
    ),
    safety_settings=[...]  # Filtros de seguridad empresarial
)
```

**B) Sistema de Instrucciones Empresariales:**

- üéØ **Personalizaci√≥n extrema** con nombre del usuario
- üìä **Uso de datos reales** (kWh, ‚Ç¨, tipo vivienda)
- üí° **C√°lculos espec√≠ficos** basados en cifras del usuario
- üè† **Adaptaci√≥n al tipo de hogar** y patrones de consumo

**C) Capacidades Conversacionales:**

- üí¨ **Memoria conversacional** a largo plazo
- üîÑ **Contexto persistente** entre sesiones
- üé≠ **Adaptaci√≥n de tono** seg√∫n el estado emocional
- üìà **Aprendizaje continuo** de preferencias del usuario

---

### 2Ô∏è‚É£ **AI LEARNING SERVICE - APRENDIZAJE AUTOM√ÅTICO**

**Ubicaci√≥n:** `expert_bot_api_COPY/app/services/ai_learning_service.py`

#### **üß† Capacidades de Aprendizaje:**

**A) Modos de Aprendizaje:**

```python
class LearningMode(Enum):
    REAL_TIME = "real_time"    # Aprendizaje inmediato por interacci√≥n
    BATCH = "batch"            # Procesamiento masivo nocturno
    HYBRID = "hybrid"          # Combinaci√≥n de ambos (ACTIVO)
```

**B) An√°lisis de Patrones de Usuario:**

```python
@dataclass
class UserPattern:
    pattern_id: str                    # ID √∫nico del patr√≥n
    pattern_type: str                  # Tipo: consumo, comportamiento, preferencia
    pattern_data: Dict[str, Any]       # Datos espec√≠ficos del patr√≥n
    confidence_score: float            # Confianza del modelo (0.0-1.0)
    usage_frequency: int               # Frecuencia de uso del patr√≥n
    business_impact: str               # Impacto en negocio: high/medium/low
    predicted_next_action: str         # Predicci√≥n de pr√≥xima acci√≥n
```

**C) Machine Learning Integrado:**

- üìä **BigQuery ML** para modelos escalables
- üîÑ **Entrenamiento autom√°tico** con nuevos datos
- üìà **Predicciones en tiempo real** sobre comportamiento
- üéØ **Segmentaci√≥n autom√°tica** de usuarios

---

### 3Ô∏è‚É£ **SISTEMA DE AN√ÅLISIS DE SENTIMENT - RECONOCIMIENTO EMOCIONAL**

#### **üé≠ An√°lisis Emocional Avanzado:**

**A) Detecci√≥n de Estados Emocionales:**

```python
def _analyze_message_sentiment(self, message: str) -> Dict[str, Any]:
    # An√°lisis de palabras clave emocionales
    positive_keywords = ["gracias", "excelente", "perfecto", "genial", "bien", "bueno"]
    negative_keywords = ["problema", "error", "mal", "malo", "frustrado", "dif√≠cil"]

    # C√°lculo de score emocional (-1.0 a 1.0)
    score = calculate_emotional_score(message)

    return {
        "score": score,                    # -1.0 (muy negativo) a 1.0 (muy positivo)
        "confidence": abs(score),          # Confianza en la detecci√≥n
        "positive_indicators": count,      # N√∫mero de indicadores positivos
        "negative_indicators": count,      # N√∫mero de indicadores negativos
        "emotional_context": context       # Contexto emocional detectado
    }
```

**B) Estados Emocionales Detectados:**

| Score Range   | Estado Emocional    | Respuesta del Sistema                     |
| ------------- | ------------------- | ----------------------------------------- |
| `0.7 a 1.0`   | üòÑ **Muy Positivo** | Mantener energ√≠a, ofrecer valor adicional |
| `0.3 a 0.6`   | üòä **Positivo**     | Continuar con tono amigable               |
| `-0.2 a 0.2`  | üòê **Neutral**      | Tono profesional est√°ndar                 |
| `-0.6 a -0.3` | üòï **Negativo**     | Tono emp√°tico, soluciones espec√≠ficas     |
| `-1.0 a -0.7` | üò† **Muy Negativo** | M√°xima empat√≠a, escalaci√≥n a soporte      |

**C) Adaptaci√≥n Autom√°tica de Respuestas:**

```python
if sentiment_analysis["score"] < -0.2:
    context_parts.append(
        "‚ö†Ô∏è USUARIO CON SENTIMENT NEGATIVO - Usar tono emp√°tico y soluciones espec√≠ficas"
    )
elif sentiment_analysis["score"] > 0.2:
    context_parts.append(
        "üòä USUARIO CON SENTIMENT POSITIVO - Mantener energ√≠a y ofrecer valor adicional"
    )
```

---

### 4Ô∏è‚É£ **AI CONFIDENCE CALCULATOR - SISTEMA DE CONFIANZA**

**Ubicaci√≥n:** `expert_bot_api_COPY/app/services/ai_confidence_calculator.py`

#### **üéØ C√°lculo de Confianza en Predicciones:**

**A) M√©tricas de Confianza:**

- üìä **Confidence Score** (0.0 - 1.0): Nivel de certeza en predicciones
- üéØ **Accuracy Rate**: Precisi√≥n hist√≥rica del modelo
- üìà **Prediction Reliability**: Fiabilidad de predicciones similares
- ‚ö†Ô∏è **Risk Assessment**: Evaluaci√≥n de riesgo de la predicci√≥n

**B) Factores que Afectan la Confianza:**

```python
confidence_factors = {
    "data_completeness": 0.3,      # Completitud de datos del usuario
    "historical_accuracy": 0.25,   # Precisi√≥n hist√≥rica en casos similares
    "pattern_consistency": 0.2,    # Consistencia con patrones conocidos
    "context_relevance": 0.15,     # Relevancia del contexto actual
    "model_certainty": 0.1         # Certeza interna del modelo
}
```

---

## üìä **TIPOS DE APRENDIZAJE IMPLEMENTADOS**

### 1Ô∏è‚É£ **APRENDIZAJE POR INTERACCI√ìN (REAL-TIME)**

#### **Datos Capturados por Conversaci√≥n:**

```python
interaction_data = {
    "user_id": "user_abc123",
    "user_message": "¬øC√≥mo puedo ahorrar en mi factura?",
    "ai_response": "Hola Juan, bas√°ndome en tu consumo de 350kWh...",
    "sentiment_score": 0.2,           # Estado emocional detectado
    "response_quality": 0.85,         # Calidad de la respuesta IA
    "user_satisfaction": "pending",    # Pendiente de feedback
    "context_used": {...},            # Contexto aplicado
    "processing_time": 1.2,           # Tiempo de procesamiento
    "ai_learning_applied": True,      # Si se aplic√≥ aprendizaje previo
    "timestamp": "2025-01-20T10:30:00Z"
}
```

#### **Patrones Aprendidos:**

- üïê **Horarios de consulta** preferidos por usuario
- üí¨ **Tipo de preguntas** m√°s frecuentes
- üé≠ **Tono de respuesta** preferido
- üìä **Nivel de detalle** deseado en explicaciones
- ‚ö° **Temas energ√©ticos** de mayor inter√©s

### 2Ô∏è‚É£ **APRENDIZAJE POR COMPORTAMIENTO (BEHAVIORAL)**

#### **An√°lisis de Patrones de Uso:**

```python
behavioral_patterns = {
    "consumption_patterns": {
        "peak_hours": [18, 19, 20, 21],    # Horas de mayor consumo
        "low_usage_days": ["sunday"],      # D√≠as de menor uso
        "seasonal_variation": 0.15,        # Variaci√≥n estacional
        "efficiency_trend": "improving"    # Tendencia de eficiencia
    },
    "interaction_patterns": {
        "preferred_conversation_length": "medium",  # Corta/Media/Larga
        "question_complexity": "intermediate",      # B√°sica/Intermedia/Avanzada
        "response_time_preference": "immediate",    # Inmediata/Reflexiva
        "follow_up_likelihood": 0.75               # Probabilidad de seguimiento
    }
}
```

### 3Ô∏è‚É£ **APRENDIZAJE PREDICTIVO (PREDICTIVE)**

#### **Modelos de Predicci√≥n:**

**A) Predicci√≥n de Consumo:**

```python
consumption_prediction = {
    "next_month_kwh": 385,             # kWh estimados pr√≥ximo mes
    "confidence": 0.82,                # Confianza en la predicci√≥n
    "factors": [
        "historical_pattern",           # Patr√≥n hist√≥rico del usuario
        "seasonal_adjustment",          # Ajuste estacional
        "behavior_changes"              # Cambios de comportamiento detectados
    ],
    "savings_potential": 45.50,        # Potencial de ahorro en ‚Ç¨
    "recommendation_priority": "high"   # Prioridad de recomendaci√≥n
}
```

**B) Predicci√≥n de Satisfacci√≥n:**

```python
satisfaction_prediction = {
    "predicted_satisfaction": 0.78,    # Satisfacci√≥n esperada (0-1)
    "risk_factors": [
        "recent_negative_sentiment",    # Sentiment negativo reciente
        "unresolved_issues"            # Problemas sin resolver
    ],
    "engagement_likelihood": 0.65,     # Probabilidad de engagement
    "churn_risk": 0.12                 # Riesgo de abandono
}
```

---

## üî¨ **ALGORITMOS DE MACHINE LEARNING IMPLEMENTADOS**

### 1Ô∏è‚É£ **PROCESAMIENTO DE LENGUAJE NATURAL (NLP)**

#### **A) An√°lisis de Intenci√≥n (Intent Recognition):**

```python
intent_categories = {
    "bill_analysis": {
        "keywords": ["factura", "coste", "precio", "pagar"],
        "confidence_threshold": 0.7,
        "processing_model": "energy_billing_classifier"
    },
    "savings_inquiry": {
        "keywords": ["ahorrar", "reducir", "bajar", "optimizar"],
        "confidence_threshold": 0.8,
        "processing_model": "savings_recommendation_engine"
    },
    "tariff_comparison": {
        "keywords": ["tarifa", "compa√±√≠a", "cambiar", "mejor"],
        "confidence_threshold": 0.75,
        "processing_model": "tariff_optimization_model"
    }
}
```

#### **B) Extracci√≥n de Entidades (Named Entity Recognition):**

```python
extracted_entities = {
    "energy_values": ["350 kWh", "85‚Ç¨", "2.0TD"],    # Valores energ√©ticos
    "temporal_references": ["este mes", "verano"],    # Referencias temporales
    "appliances": ["aire acondicionado", "calefacci√≥n"], # Electrodom√©sticos
    "locations": ["cocina", "sal√≥n", "dormitorio"],   # Ubicaciones en hogar
    "emotions": ["preocupado", "satisfecho"]          # Estados emocionales
}
```

### 2Ô∏è‚É£ **CLUSTERING Y SEGMENTACI√ìN**

#### **A) Segmentaci√≥n Autom√°tica de Usuarios:**

```python
user_segments = {
    "high_consumption_aware": {
        "criteria": "consumption > 400kWh AND engagement = high",
        "characteristics": ["Conscientes del gasto", "Buscan optimizaci√≥n"],
        "recommended_approach": "Datos t√©cnicos, comparativas detalladas",
        "ai_personality": "Anal√≠tica y precisa"
    },
    "budget_conscious": {
        "criteria": "price_sensitivity = high AND questions about costs",
        "characteristics": ["Sensibles al precio", "Buscan ahorros"],
        "recommended_approach": "Enfoque en ahorro econ√≥mico",
        "ai_personality": "Emp√°tica y centrada en soluciones"
    },
    "eco_friendly": {
        "criteria": "solar_panels = true OR sustainability keywords",
        "characteristics": ["Conciencia ecol√≥gica", "Inter√©s en renovables"],
        "recommended_approach": "Impacto ambiental, sostenibilidad",
        "ai_personality": "Inspiradora y educativa"
    }
}
```

### 3Ô∏è‚É£ **SERIES TEMPORALES Y PREDICCI√ìN**

#### **A) An√°lisis de Tendencias:**

```python
temporal_analysis = {
    "consumption_trend": {
        "direction": "decreasing",      # increasing/stable/decreasing
        "rate": -0.05,                 # Tasa de cambio mensual
        "seasonality": {
            "summer_peak": 1.3,        # Factor de pico verano
            "winter_increase": 1.15     # Factor incremento invierno
        },
        "anomaly_detection": {
            "outliers_detected": 2,     # Valores an√≥malos detectados
            "possible_causes": ["Vacaciones", "Electrodom√©stico nuevo"]
        }
    }
}
```

#### **B) Modelos de Forecasting:**

```python
forecasting_models = {
    "short_term": {
        "model_type": "ARIMA",
        "prediction_horizon": "7_days",
        "accuracy": 0.85,
        "last_trained": "2025-01-20T08:00:00Z"
    },
    "medium_term": {
        "model_type": "LSTM_Neural_Network",
        "prediction_horizon": "3_months",
        "accuracy": 0.78,
        "features": ["historical_consumption", "weather", "user_behavior"]
    },
    "long_term": {
        "model_type": "BigQuery_ML_Linear_Regression",
        "prediction_horizon": "12_months",
        "accuracy": 0.72,
        "includes_external_factors": True
    }
}
```

---

## üíæ **ALMACENAMIENTO Y GESTI√ìN DE DATOS IA**

### 1Ô∏è‚É£ **TABLAS BIGQUERY ESPECIALIZADAS**

#### **A) ai_learning_data - Datos de Aprendizaje:**

```sql
CREATE TABLE `smarwatt_data.ai_learning_data` (
    learning_id STRING,
    user_id STRING,
    interaction_timestamp TIMESTAMP,
    learning_type STRING,           -- 'conversation', 'behavior', 'prediction'
    input_data JSON,               -- Datos de entrada
    model_output JSON,             -- Salida del modelo
    confidence_score FLOAT64,      -- Confianza del modelo
    user_feedback STRING,          -- Feedback del usuario
    validation_result STRING,      -- Resultado de validaci√≥n
    model_version STRING,          -- Versi√≥n del modelo usado
    processing_time_ms INT64,      -- Tiempo de procesamiento
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP()
);
```

#### **B) sentiment_analysis - An√°lisis Emocional:**

```sql
CREATE TABLE `smarwatt_data.sentiment_analysis` (
    analysis_id STRING,
    user_id STRING,
    message_text STRING,
    sentiment_score FLOAT64,       -- Score de -1.0 a 1.0
    sentiment_label STRING,        -- 'positive', 'negative', 'neutral'
    confidence FLOAT64,            -- Confianza en la detecci√≥n
    emotional_indicators JSON,     -- Indicadores emocionales detectados
    context_factors JSON,          -- Factores de contexto
    response_adaptation STRING,    -- Adaptaci√≥n aplicada a la respuesta
    timestamp TIMESTAMP
);
```

#### **C) user_behavior_patterns - Patrones de Usuario:**

```sql
CREATE TABLE `smarwatt_data.user_behavior_patterns` (
    pattern_id STRING,
    user_id STRING,
    pattern_type STRING,           -- 'consumption', 'interaction', 'preference'
    pattern_data JSON,             -- Datos espec√≠ficos del patr√≥n
    confidence_score FLOAT64,      -- Confianza estad√≠stica
    frequency INT64,               -- Frecuencia del patr√≥n
    last_observed TIMESTAMP,       -- √öltima observaci√≥n
    business_impact STRING,        -- 'high', 'medium', 'low'
    predicted_evolution JSON,      -- Evoluci√≥n predicha del patr√≥n
    created_at TIMESTAMP
);
```

### 2Ô∏è‚É£ **CACHE Y OPTIMIZACI√ìN**

#### **A) Cache de Predicciones:**

```python
prediction_cache = {
    "user_123": {
        "consumption_prediction": {
            "value": 385.5,
            "confidence": 0.82,
            "cached_at": "2025-01-20T10:00:00Z",
            "expires_at": "2025-01-20T11:00:00Z"
        },
        "sentiment_history": {
            "last_7_days": [0.2, 0.5, -0.1, 0.3, 0.8, 0.1, 0.4],
            "average": 0.31,
            "trend": "stable"
        }
    }
}
```

---

## üéØ **PERSONALIZACI√ìN AVANZADA DEL SISTEMA IA**

### 1Ô∏è‚É£ **ADAPTACI√ìN POR PERFIL DE USUARIO**

#### **A) Niveles de Personalizaci√≥n:**

**üî∞ NIVEL B√ÅSICO (Usuario Nuevo):**

```python
basic_personalization = {
    "greeting": "Hola, soy tu asistente energ√©tico",
    "response_style": "general_informative",
    "data_usage": "generic_examples",
    "complexity": "basic",
    "learning_mode": "observation_only"
}
```

**ü•â NIVEL INTERMEDIO (Usuario con Datos):**

```python
intermediate_personalization = {
    "greeting": f"Hola {user_name}, bas√°ndome en tu perfil...",
    "response_style": "semi_personalized",
    "data_usage": "user_specific_references",
    "complexity": "intermediate",
    "learning_mode": "active_learning"
}
```

**üèÜ NIVEL AVANZADO (Usuario Experiencia Completa):**

```python
advanced_personalization = {
    "greeting": f"¬°Hola de nuevo {user_name}! He analizado tu consumo...",
    "response_style": "highly_personalized",
    "data_usage": "full_context_aware",
    "complexity": "advanced_with_predictions",
    "learning_mode": "predictive_suggestions"
}
```

### 2Ô∏è‚É£ **SISTEMA DE RECOMENDACIONES INTELIGENTES**

#### **A) Motor de Recomendaciones:**

```python
recommendation_engine = {
    "input_factors": [
        "user_consumption_history",    # Historial de consumo
        "home_characteristics",        # Caracter√≠sticas del hogar
        "seasonal_patterns",           # Patrones estacionales
        "user_preferences",            # Preferencias declaradas
        "similar_users_success",       # √âxito en usuarios similares
        "market_opportunities"         # Oportunidades del mercado
    ],
    "output_recommendations": [
        {
            "type": "tariff_change",
            "description": "Cambio a tarifa nocturna",
            "estimated_savings": 45.30,
            "confidence": 0.87,
            "effort_required": "low",
            "implementation_time": "15_minutes"
        },
        {
            "type": "usage_optimization",
            "description": "Uso electrodom√©sticos en valle",
            "estimated_savings": 18.70,
            "confidence": 0.92,
            "effort_required": "medium",
            "habit_change_required": True
        }
    ]
}
```

---

## üìà **M√âTRICAS Y EVALUACI√ìN DEL SISTEMA IA**

### 1Ô∏è‚É£ **M√âTRICAS DE RENDIMIENTO**

#### **A) M√©tricas de Modelo:**

```python
model_metrics = {
    "accuracy": 0.87,                    # Precisi√≥n general
    "precision": 0.84,                   # Precisi√≥n positiva
    "recall": 0.91,                      # Cobertura
    "f1_score": 0.87,                    # Score F1
    "prediction_latency": "150ms",       # Latencia de predicci√≥n
    "model_drift": 0.02,                 # Deriva del modelo
    "confidence_calibration": 0.94       # Calibraci√≥n de confianza
}
```

#### **B) M√©tricas de Usuario:**

```python
user_metrics = {
    "user_satisfaction": 0.82,           # Satisfacci√≥n del usuario
    "task_completion_rate": 0.89,        # Tasa de completaci√≥n de tareas
    "conversation_length": 4.2,          # Longitud promedio conversaci√≥n
    "return_user_rate": 0.76,            # Tasa de usuarios que regresan
    "recommendation_acceptance": 0.68,    # Aceptaci√≥n de recomendaciones
    "sentiment_improvement": 0.15         # Mejora de sentiment por conversaci√≥n
}
```

### 2Ô∏è‚É£ **ALERTAS Y MONITORIZACI√ìN**

#### **A) Alertas Autom√°ticas:**

```python
ai_alerts = {
    "model_performance_degradation": {
        "threshold": "accuracy < 0.80",
        "action": "retrain_model",
        "notification": "ml_engineering_team"
    },
    "negative_sentiment_spike": {
        "threshold": "avg_sentiment < -0.3 for 1_hour",
        "action": "escalate_to_human_support",
        "notification": "customer_success_team"
    },
    "prediction_confidence_low": {
        "threshold": "confidence < 0.60",
        "action": "fallback_to_conservative_response",
        "notification": "data_science_team"
    }
}
```

---

## üîÑ **FLUJO COMPLETO DE PROCESAMIENTO IA**

### üì• **ENTRADA DEL USUARIO**

```
Usuario: "Hola, ¬øpor qu√© mi factura es tan alta este mes?"
```

### üîç **PASO 1: AN√ÅLISIS INICIAL**

```python
# 1. Detecci√≥n de intenci√≥n
intent = "bill_analysis"
confidence = 0.89

# 2. An√°lisis de sentiment
sentiment = {
    "score": -0.3,
    "label": "concerned",
    "confidence": 0.82
}

# 3. Extracci√≥n de entidades
entities = {
    "temporal": "este mes",
    "concern_topic": "factura alta",
    "emotion": "preocupaci√≥n"
}
```

### üß† **PASO 2: ENRIQUECIMIENTO CON IA**

```python
# 1. Obtenci√≥n de contexto de usuario
user_context = get_user_context_from_expert_bot()

# 2. An√°lisis de patrones hist√≥ricos
patterns = ai_learning_service.get_user_patterns(user_id)

# 3. Predicciones relevantes
predictions = {
    "bill_increase_cause": "seasonal_heating_usage",
    "confidence": 0.78,
    "potential_savings": 32.50
}
```

### üéØ **PASO 3: GENERACI√ìN DE RESPUESTA**

```python
# 1. Construcci√≥n de prompt enriquecido
enhanced_prompt = f"""
üè¢ CONTEXTO EMPRESARIAL SMARWATT
üë§ USUARIO: {user_name}
üìä CONSUMO ACTUAL: {consumption_kwh} kWh (+15% vs mes anterior)
üß† SENTIMENT DETECTADO: Preocupado (-0.3 score)
üéØ CAUSA PROBABLE: Uso de calefacci√≥n por fr√≠o
üí∞ AHORRO POTENCIAL: 32.50‚Ç¨ con optimizaci√≥n

PREGUNTA: {user_message}

INSTRUCCIONES:
- Dirigirse SIEMPRE como {user_name}
- Explicar causa espec√≠fica del incremento
- Proporcionar soluciones concretas
- Usar tono emp√°tico por sentiment negativo
- Incluir c√°lculos espec√≠ficos de ahorro
"""

# 2. Generaci√≥n con Gemini
ai_response = gemini_model.generate_content(enhanced_prompt)
```

### üì§ **PASO 4: RESPUESTA FINAL**

```
"Hola Juan, he analizado tu factura y entiendo tu preocupaci√≥n.

El incremento del 15% (52‚Ç¨ adicionales) se debe principalmente al
uso de calefacci√≥n durante los d√≠as fr√≠os de enero. Tu consumo
pas√≥ de 350 kWh a 402 kWh.

üí° Te propongo 3 acciones inmediatas:
1. Programar calefacci√≥n 19¬∞C (ahorro: 18‚Ç¨/mes)
2. Usar solo en habitaciones ocupadas (ahorro: 12‚Ç¨/mes)
3. Cambiar a tarifa nocturna (ahorro: 8‚Ç¨/mes)

Total ahorro potencial: 38‚Ç¨/mes

¬øTe gustar√≠a que analice cu√°l de estas opciones se adapta mejor
a tu rutina diaria?"
```

### üìä **PASO 5: APRENDIZAJE Y M√âTRICAS**

```python
# 1. Registro de interacci√≥n
interaction_log = {
    "user_satisfaction": "pending",
    "response_quality": 0.91,
    "personalization_applied": True,
    "learning_points": [
        "User concerned about heating costs",
        "Responds well to specific calculations",
        "Prefers step-by-step solutions"
    ]
}

# 2. Actualizaci√≥n de patrones
updated_patterns = {
    "seasonal_sensitivity": "high",
    "prefers_detailed_explanations": True,
    "cost_conscious": True
}

# 3. Predicciones futuras
future_predictions = {
    "likely_next_question": "tariff_comparison",
    "engagement_probability": 0.85,
    "satisfaction_prediction": 0.78
}
```

---

## üîÆ **ROADMAP DE IA Y MACHINE LEARNING**

### **Versi√≥n 2025.2.0:**

- üß† **Modelos de lenguaje especializados** en energ√≠a
- üé≠ **Reconocimiento de emociones** por an√°lisis de texto avanzado
- üì± **Integraci√≥n con IoT** para datos de consumo en tiempo real

### **Versi√≥n 2025.3.0:**

- ü§ñ **Agentes IA aut√≥nomos** para gesti√≥n proactiva
- üîÆ **Predicci√≥n de aver√≠as** de electrodom√©sticos
- üåç **Modelos de optimizaci√≥n global** de red el√©ctrica

### **Versi√≥n 2026.1.0:**

- üß¨ **IA Generativa Multimodal** (texto, voz, imagen)
- üè† **Gemelo digital** del hogar del usuario
- ‚ö° **Optimizaci√≥n autom√°tica** de toda la instalaci√≥n el√©ctrica

---

## üéØ **CONCLUSI√ìN - VALOR EMPRESARIAL DEL SISTEMA IA**

El sistema de IA de SmarWatt no es solo un chatbot, sino un **ecosistema inteligente completo** que:

‚úÖ **Aprende continuamente** de cada interacci√≥n  
‚úÖ **Personaliza al m√°ximo** cada respuesta  
‚úÖ **Predice necesidades** antes de que el usuario las exprese  
‚úÖ **Optimiza autom√°ticamente** las recomendaciones  
‚úÖ **Detecta y adapta** el estado emocional del usuario  
‚úÖ **Proporciona valor medible** en ahorros reales

**üéØ RESULTADO:** Una experiencia de usuario que mejora exponencialmente con el tiempo, generando mayor satisfacci√≥n, engagement y resultados de negocio.
