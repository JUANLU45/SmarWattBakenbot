# ğŸ¤– DOCUMENTACIÃ“N COMPLETA - EXPERT BOT API

## ğŸ“‹ **INFORMACIÃ“N GENERAL**

**Nombre del Microservicio:** Expert Bot API  
**VersiÃ³n:** 2.0.0 - EMPRESARIAL COPY  
**Puerto:** 8080  
**TecnologÃ­a:** Flask + Python 3.10+  
**Base de Datos:** Firebase Firestore + BigQuery  
**AutenticaciÃ³n:** Firebase Admin SDK + JWT

---

## ğŸ“ **ESTRUCTURA COMPLETA DE ARCHIVOS**

```
expert_bot_api_COPY/
â”‚
â”œâ”€â”€ ğŸ“„ ARCHIVOS DE CONFIGURACIÃ“N
â”‚   â”œâ”€â”€ .env                     # Variables de entorno (SENSIBLE)
â”‚   â”œâ”€â”€ .env.example            # Plantilla de variables de entorno
â”‚   â”œâ”€â”€ .dockerignore           # Archivos ignorados por Docker
â”‚   â”œâ”€â”€ Dockerfile              # ConfiguraciÃ³n de contenedor Docker
â”‚   â”œâ”€â”€ pyproject.toml          # ConfiguraciÃ³n del proyecto Python
â”‚   â”œâ”€â”€ requirements-base.txt   # Dependencias base del proyecto
â”‚   â”œâ”€â”€ requirements-dev.txt    # Dependencias de desarrollo
â”‚   â”œâ”€â”€ requirements-ml.txt     # Dependencias de Machine Learning
â”‚   â”œâ”€â”€ requirements.txt        # TODAS las dependencias
â”‚   â””â”€â”€ run.py                  # ğŸš€ ARCHIVO PRINCIPAL DE EJECUCIÃ“N
â”‚
â”œâ”€â”€ ğŸ“¦ app/ - NÃšCLEO DE LA APLICACIÃ“N
â”‚   â”œâ”€â”€ __init__.py             # âš™ï¸ Inicializador de la aplicaciÃ³n Flask
â”‚   â”œâ”€â”€ config.py               # ğŸ”§ Configuraciones por entorno
â”‚   â”‚
â”‚   â”œâ”€â”€ ğŸ›£ï¸ RUTAS PRINCIPALES
â”‚   â”œâ”€â”€ routes.py               # Endpoints bÃ¡sicos y salud del sistema
â”‚   â”œâ”€â”€ async_routes.py         # ğŸ”„ Endpoints de tareas asÃ­ncronas + ADMIN
â”‚   â”œâ”€â”€ energy_routes.py        # âš¡ Endpoints de energÃ­a y perfiles
â”‚   â”œâ”€â”€ cross_service_routes.py # ğŸ”— ComunicaciÃ³n entre microservicios
â”‚   â””â”€â”€ links_routes.py         # ğŸ”— GestiÃ³n de enlaces y redirecciones
â”‚   â”‚
â”‚   â”œâ”€â”€ ğŸ”§ SERVICIOS CORE
â”‚   â”œâ”€â”€ energy_service.py       # ğŸ“Š LÃ³gica de negocio energÃ©tica
â”‚   â””â”€â”€ services/               # ğŸ“ Servicios especializados
â”‚       â”œâ”€â”€ ai_service.py       # ğŸ¤– Servicio de IA y Machine Learning
â”‚       â”œâ”€â”€ async_service.py    # â° GestiÃ³n de tareas asÃ­ncronas
â”‚       â”œâ”€â”€ bigquery_service.py # ğŸ“ˆ IntegraciÃ³n con BigQuery
â”‚       â”œâ”€â”€ energy_service.py   # âš¡ Servicios energÃ©ticos avanzados
â”‚       â”œâ”€â”€ firebase_service.py # ğŸ”¥ IntegraciÃ³n con Firebase
â”‚       â””â”€â”€ ml_service.py       # ğŸ§  Servicios de Machine Learning
â”‚
â”œâ”€â”€ ğŸ” smarwatt_auth/ - SISTEMA DE AUTENTICACIÃ“N
â”‚   â”œâ”€â”€ __init__.py            # Inicializador del mÃ³dulo de auth
â”‚   â””â”€â”€ auth.py                # ğŸ›¡ï¸ Decoradores y lÃ³gica de autenticaciÃ³n
â”‚
â”œâ”€â”€ ğŸ› ï¸ utils/ - UTILIDADES EMPRESARIALES
â”‚   â”œâ”€â”€ __init__.py            # Inicializador de utilidades
â”‚   â”œâ”€â”€ error_handlers.py      # ğŸš¨ Manejo de errores empresarial
â”‚   â”œâ”€â”€ logging_config.py      # ğŸ“ ConfiguraciÃ³n de logs
â”‚   â””â”€â”€ validators.py          # âœ… Validadores de datos
â”‚
â”œâ”€â”€ ğŸ“Š logs/ - ARCHIVOS DE LOG
â”‚   â””â”€â”€ expert_bot_api_*.log   # Logs rotativos por fecha
â”‚
â”œâ”€â”€ ğŸ§ª ARCHIVOS DE TESTING
â”‚   â””â”€â”€ test_integration.py    # Tests de integraciÃ³n
â”‚
â””â”€â”€ ğŸ³ ARCHIVOS DOCKER Y CACHE
    â””â”€â”€ __pycache__/           # Cache de Python (auto-generado)
```

---

## âš™ï¸ **COMPONENTES PRINCIPALES**

### 1ï¸âƒ£ **run.py - EJECUTOR PRINCIPAL**

**UbicaciÃ³n:** `expert_bot_api_COPY/run.py`

**FunciÃ³n:** Punto de entrada principal de la aplicaciÃ³n

**CaracterÃ­sticas:**

- âœ… ConfiguraciÃ³n de logging empresarial
- âœ… InicializaciÃ³n de la aplicaciÃ³n Flask
- âœ… ConfiguraciÃ³n de entorno automÃ¡tica
- âœ… Manejo de errores de inicio
- âœ… Logging rotativo por fechas

**ConfiguraciÃ³n de Inicio:**

```python
# Variables de entorno importantes
PORT = int(os.getenv("PORT", 8080))
HOST = os.getenv("HOST", "0.0.0.0")
DEBUG = os.getenv("DEBUG", "False").lower() == "true"
FLASK_CONFIG =**s.ge**nv("FLASK_CONFIG", "production")

```

### 2ï¸âƒ£ **app/**init**.py - INICIALIZADOR DE APLICACIÃ“N**

**UbicaciÃ³n:** `expert_bot_api_COPY/app/__init__.py`

**FunciÃ³n:** ConfiguraciÃ³n y creaciÃ³n de la aplicaciÃ³n Flask

**Componentes CrÃ­ticos:**

- ğŸ”¥ **InicializaciÃ³n Firebase Admin SDK**
- ğŸŒ **ConfiguraciÃ³n CORS empresarial**

- ğŸ›£ï¸ **Registro de blueprints**
- ğŸš¨ **Manejo de errores global**
- ğŸ“ **Middleware de logging**

**Blueprints Registrados:**

```python
# Registro de rutas principales
app.register_blueprint(routes_bp, url_prefix="/api/v1")
app.register_blueprint(async_bp, url_prefix="/api/v1/async")

app.register_blueprint(energy_bp, url_prefix="/api/v1/energy")
app.register_blueprint(cross_service_bp, url_prefix="/api/v1/chat")
app.register_blueprint(links_bp, url_prefix="/api/v1/links")
```

### 3ï¸âƒ£ **config.py - CONFIGURACIONES POR ENTORNO**

**UbicaciÃ³n:** `expert_bot_api_COPY/app/config.py`

**FunciÃ³n:** GestiÃ³n de configuraciones por entorno (development, production, testing)

**Configuraciones CrÃ­ticas:**

- ğŸ”‘ **Credenciales Google Cloud**
- ğŸ“Š **ConfiguraciÃ³n BigQuery**
- ğŸ”¥ **ConfiguraciÃ³n Firebase**

- ğŸŒ **CORS Origins**
- ğŸ“ **Niveles de logging**

---

## ğŸ›£ï¸ **DOCUMENTACIÃ“N DE RUTAS**

### 1ï¸âƒ£ **routes.py - ENDPOINTS BÃSICOS**

**Prefijo:** `/api/v1`

| Endpoint   | MÃ©todo | FunciÃ³n             | DescripciÃ³n                    |
| ---------- | ------ | ------------------- | ------------------------------ |
| `/health`  | GET    | `health_check()`    | âœ… Estado de salud del sistema |
| `/ready`   | GET    | `readiness_check()` | âœ… Estado de preparaciÃ³n       |
| `/version` | GET    | `get_version()`     | ğŸ“Š InformaciÃ³n de versiÃ³n      |

### 2ï¸âƒ£ **async_routes.py - TAREAS ASÃNCRONAS + ADMIN**

**Prefijo:** `/api/v1/async`

| Endpoint                  | MÃ©todo | Auth     | FunciÃ³n                                             |
| ------------------------- | ------ | -------- | --------------------------------------------------- |
| `/submit`                 | POST   | ğŸ”’ Token | `submit_task()` - Enviar tarea asÃ­ncrona            |
| `/status/<task_id>`       | GET    | ğŸ”’ Token | `get_task_status()` - Estado de tarea               |
| `/admin/system/metrics`   | GET    | ğŸ¢ Admin | `get_admin_system_metrics()` - MÃ©tricas del sistema |
| `/admin/tasks/management` | GET    | ğŸ¢ Admin | `get_admin_task_management()` - GestiÃ³n de tareas   |

### 3ï¸âƒ£ **energy_routes.py - SERVICIOS ENERGÃ‰TICOS**

**Prefijo:** `/api/v1/energy`

| Endpoint   | MÃ©todo | Auth     | FunciÃ³n                                                     |
| ---------- | ------ | -------- | ----------------------------------------------------------- |
| `/profile` | GET    | ğŸ”’ Token | `get_user_energy_profile()` - Perfil energÃ©tico del usuario |

| `/consumption/analysis` | POST | ğŸ”’ Token | `analyze_consumption()` - AnÃ¡lisis de consumo |
| `/recommendations` | GET | ğŸ”’ Token | `get_energy_recommendations()` - Recomendaciones |

### 4ï¸âƒ£ **cross_service_routes.py - COMUNICACIÃ“N INTER-MICROSERVICIOS**

**Prefijo:** `/api/v1/chat`

| Endpoint         | MÃ©todo | Auth     | FunciÃ³n                                                         |
| ---------------- | ------ | -------- | --------------------------------------------------------------- |
| `/cross-service` | POST   | ğŸ”’ Token | `handle_cross_service_request()` - ComunicaciÃ³n entre servicios |

### 5ï¸âƒ£ **links_routes.py - GESTIÃ“N DE ENLACES**

**Prefijo:** `/api/v1/links`

| Endpoint             | MÃ©todo | Auth     | FunciÃ³n                            |
| -------------------- | ------ | -------- | ---------------------------------- |
| `/create`            | POST   | ğŸ”’ Token | `create_link()` - Crear enlace     |
| `/resolve/<link_id>` | GET    | PÃºblico  | `resolve_link()` - Resolver enlace |

---

## ğŸ”§ **SERVICIOS ESPECIALIZADOS**

### 1ï¸âƒ£ **energy_service.py - SERVICIOS ENERGÃ‰TICOS CORE**

**UbicaciÃ³n:** `app/energy_service.py`

**Funciones Principales:**

- ğŸ”„ `_get_user_energy_profile_enterprise()` - ObtenciÃ³n de perfiles energÃ©ticos
- âœ¨ `_create_minimal_user_profile()` - **CREACIÃ“N AUTOMÃTICA DE PERFILES**
- ğŸ“Š `get_enhanced_user_context()` - Contexto completo del usuario

**Funcionalidad CrÃ­tica:**

```python
# Auto-creaciÃ³n de perfiles cuando no existen
if not profile_data:
    logger.info(f"Perfil no encontrado para {user_id}, creando perfil mÃ­nimo")
    minimal_profile = await _create_minimal_user_profile(user_id, firebase_user)

```

### 2ï¸âƒ£ **services/async_service.py - GESTIÃ“N ASÃNCRONA**

**Funciones Principales:**

- â° `submit_task()` - EnvÃ­o de tareas asÃ­ncronas
- ğŸ“Š `get_task_status()` - Estado de tareas
- ğŸ“ˆ `get_system_status()` - MÃ©tricas del sistema
- ğŸ‘¥ `get_worker_metrics()` - MÃ©tricas de workers

### 3ï¸âƒ£ **services/bigquery_service.py - INTEGRACIÃ“N BIGQUERY**

**Funciones Principales:**

- ğŸ“Š `execute_query()` - EjecuciÃ³n de queries
- ğŸ’¾ `insert_data()` - InserciÃ³n de datos

- ğŸ“ˆ `get_analytics_data()` - Datos analÃ­ticos

### 4ï¸âƒ£ **services/firebase_service.py - INTEGRACIÃ“N FIREBASE**

**Funciones Principales:**

- ğŸ‘¤ `get_user_profile()` - Perfiles de usuario
- ğŸ’¾ `update_user_data()` - ActualizaciÃ³n de datos
- ğŸ” `verify_token()` - VerificaciÃ³n de tokens

---

## ğŸ” **SISTEMA DE AUTENTICACIÃ“N**

### **smarwatt_auth/auth.py**

**Decoradores Disponibles:**

- ğŸ”’ `@token_required` - AutenticaciÃ³n bÃ¡sica
- ğŸ¢ `@admin_required` - Acceso administrativo
- ğŸ“Š `@enterprise_auth` - AutenticaciÃ³n empresarial

**Usuario Admin Autorizado:**

- **Nombre:** "Tomates Juanlu"
- **UID:** `56bE1dNrjef8kO0Erg1qKQytKAq2`
- **Rol:** `admin`

**Flujo de AutenticaciÃ³n:**

```python
1. ExtracciÃ³n del token del header Authorization
2. VerificaciÃ³n con Firebase Admin SDK
3. ObtenciÃ³n del contexto del usuario

4. ValidaciÃ³n de roles y permisos
5. Establecimiento del contexto global (g.user)
```

---

## ğŸ’¾ **INTEGRACIÃ“N CON BASES DE DATOS**

### **Firebase Firestore - Colecciones:**

- ğŸ‘¥ `users` - Datos bÃ¡sicos de usuarios
- ğŸ“Š `user_profiles_enriched` - Perfiles energÃ©ticos completos
- ğŸ“„ `documents` - Documentos subidos
- ğŸ”— `links` - Enlaces gestionados

### **BigQuery - Tablas:**

- â° `async_tasks` - Tareas asÃ­ncronas
- ğŸ‘¥ `worker_metrics` - MÃ©tricas de workers
- ğŸ“Š `user_analytics` - AnalÃ­tica de usuarios

- ğŸ“„ `uploaded_documents_log` - Log de documentos

---

## ğŸš€ **INSTRUCCIONES DE DESPLIEGUE**

### **1. PreparaciÃ³n del Entorno:**

```bash

# Instalar dependencias
pip install -r requirements.txt

# Configurar variables de entorno
cp .env.example .env
# Editar .env con las credenciales correctas
```

### **2. EjecuciÃ³n Local:**

```bash
# Modo desarrollo
python run.py


# Modo producciÃ³n
export FLASK_CONFIG=production
python run.py
```

### **3. Docker:**

```bash
# Construir imagen
docker build -t expert-bot-api .


# Ejecutar contenedor
docker run -p 8080:8080 expert-bot-api
```

### **4. Google Cloud Run:**

```bash
# Deploy automÃ¡tico
gcloud run deploy expert-bot-api \
  --source . \
  --platform managed \
  --region europe-west1 \
  --allow-unauthenticated
```

---

## ğŸ› ï¸ **MANTENIMIENTO Y MONITORIZACIÃ“N**

### **Logs Importantes:**

- ğŸ“ `expert_bot_api_YYYYMMDD.log` - Logs principales
- ğŸš¨ `error.log` - Solo errores crÃ­ticos
- ğŸ“Š `access.log` - Logs de acceso HTTP

### **MÃ©tricas a Monitorizar:**

- ğŸƒ **Rendimiento:** Tiempo de respuesta de endpoints
- ğŸ‘¥ **Usuarios:** Nuevos registros y actividad
- âš¡ **Tareas:** Cola de tareas asÃ­ncronas
- ğŸ’¾ **Memoria:** Uso de recursos del sistema

### **Endpoints de Salud:**

- `/api/v1/health` - Estado general
- `/api/v1/ready` - PreparaciÃ³n para trÃ¡fico
- `/api/v1/version` - InformaciÃ³n de versiÃ³n

### **Alertas CrÃ­ticas:**

- ğŸš¨ Error rate > 5%
- â° Response time > 2s
- ğŸ’¾ Memory usage > 80%
- ğŸ“Š BigQuery quota exceeded

---

## ğŸ”§ **CONFIGURACIÃ“N DE VARIABLES DE ENTORNO**

### **Variables CrÃ­ticas (.env):**

```env

# ConfiguraciÃ³n de la aplicaciÃ³n
FLASK_CONFIG=production
PORT=8080
DEBUG=False

# Google Cloud Platform

GCP_PROJECT_ID=smarwatt-c85f4
GOOGLE_APPLICATION_CREDENTIALS=/path/to/service-account.json

# BigQuery
BQ_DATASET_ID=smarwatt_data
BQ_ASYNC_TASKS_TABLE_ID=async_tasks

BQ_WORKER_METRICS_TABLE_ID=worker_metrics

# Firebase
FIREBASE_PROJECT_ID=smarwatt-c85f4

# Seguridad
SECRET_KEY=your-secret-key-here
CORS_ORIGINS=https://smarwatt.com,https://admin.smarwatt.com

# Logging

LOG_LEVEL=INFO
```

---

## ğŸ› **SOLUCIÃ“N DE PROBLEMAS COMUNES**

### **1. Error de AutenticaciÃ³n Firebase:**

```

Error: Firebase Admin SDK no inicializado
SoluciÃ³n: Verificar GOOGLE_APPLICATION_CREDENTIALS
```

### **2. Error de ConexiÃ³n BigQuery:**

```
Error: 403 Forbidden
SoluciÃ³n: Verificar permisos del service account
```

### **3. Error en CreaciÃ³n de Perfiles:**

```
Error: user_profiles_enriched no encontrado
SoluciÃ³n: Verificar que la colecciÃ³n existe en Firestore
```

### **4. Error de CORS:**

```
Error: CORS policy blocked
SoluciÃ³n: AÃ±adir dominio a CORS_ORIGINS en .env
```

---

## ğŸ“ˆ **ROADMAP Y MEJORAS FUTURAS**

### **VersiÃ³n 2.1.0:**

- ğŸ¤– IntegraciÃ³n con mÃ¡s modelos de IA

- ğŸ“Š Dashboard de analÃ­tica avanzada
- ğŸ”„ Mejoras en el sistema de tareas asÃ­ncronas

### **VersiÃ³n 2.2.0:**

- ğŸŒ Soporte multi-idioma
- ğŸ“± API mÃ³vil optimizada
- ğŸ” AutenticaciÃ³n SSO

### **VersiÃ³n 3.0.0:**

- ğŸš€ MigraciÃ³n a arquitectura de microservicios
- â˜ï¸ Soporte multi-cloud

- ğŸ§  IA predictiva avanzada

---

## ğŸ”— **COMUNICACIÃ“N ENTRE MICROSERVICIOS**

### **ARQUITECTURA DE COMUNICACIÃ“N**

El Expert Bot API actÃºa como el **servicio central de gestiÃ³n de usuarios y datos**, mientras que Energy IA API se especializa en **conversaciones y anÃ¡lisis energÃ©tico**. La comunicaciÃ³n entre ambos es bidireccional y robusta.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     â”‚  HTTP   â”‚                     â”‚
â”‚   ENERGY IA API     â”‚ â”€â”€â”€â”€â”€â”€â–º â”‚   EXPERT BOT API    â”‚
â”‚   (Puerto 8081)     â”‚ Requestsâ”‚   (Puerto 8080)     â”‚
â”‚                     â”‚ â—„â”€â”€â”€â”€â”€â”€ â”‚                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     Especialista                  Gestor Central
     Conversacional                de Datos
```

### **1ï¸âƒ£ ENDPOINT DE COMUNICACIÃ“N PRINCIPAL**

#### **Expert Bot API - Receptor Cross-Service**

**Endpoint:** `POST /api/v1/chat/cross-service`  
**UbicaciÃ³n:** `expert_bot_api_COPY/app/cross_service_routes.py`

**FunciÃ³n:** Recibe peticiones del Energy IA API para procesamiento con contexto completo del usuario.

**Request Format:**

```json
{
    "message": "Â¿CuÃ¡nto puedo ahorrar cambiando de tarifa?",
    "user_id": "user_abc123",
    "source": "energy_ia_api",
    "conversation_context": {
        "previous_messages": [...],
        "current_topic": "tariff_comparison"
    }
}
```

**Response Format:**

```json
{
  "status": "success",
  "response": "BasÃ¡ndome en tu perfil energÃ©tico, Juan...",
  "conversation_id": "conv_xyz789",
  "user_context": {
    "user_name": "Juan",
    "has_complete_data": true,
    "home_type": "apartment",

    "consumption_profile": "medium"
  },
  "timestamp": "2025-01-20T10:30:00Z"
}
```

### **2ï¸âƒ£ FLUJO DE COMUNICACIÃ“N DETALLADO**

#### **Escenario: Usuario chatea en Energy IA API**

1. **ğŸ“± Usuario envÃ­a mensaje** al chatbot en Energy IA API
2. **ğŸ” Energy IA API valida** el token del usuario
3. **ğŸ“ Solicitud Cross-Service** a Expert Bot API:

   ```python
   # Energy IA API hace peticiÃ³n
   response = requests.post(

       f"{expert_bot_url}/api/v1/chat/cross-service",
       headers={"Authorization": f"Bearer {user_token}"},
       json={
           "message": user_message,
           "user_id": user_id,
           "source": "energy_ia_api"
       }
   )
   ```

4. **ğŸ¢ Expert Bot API procesa** la peticiÃ³n:

   - Verifica autenticaciÃ³n del usuario
   - Obtiene/crea perfil energÃ©tico del usuario
   - Enriquece contexto con datos de BigQuery/Firebase
   - Procesa mensaje con ChatService especializado

5. **ğŸ“Š Respuesta enriquecida** de Expert Bot API:

   - Contexto completo del usuario
   - Respuesta procesada con IA
   - Metadatos de conversaciÃ³n

6. **ğŸ¤– Energy IA API genera** respuesta final:

   - Combina contexto recibido
   - Aplica especializaciÃ³n energÃ©tica

   - Personaliza respuesta con nombre del usuario
   - Retorna respuesta al usuario

### **3ï¸âƒ£ GESTIÃ“N DE PERFILES DE USUARIO**

#### **Auto-CreaciÃ³n de Perfiles (Expert Bot API)**

**FunciÃ³n:** `_create_minimal_user_profile()`  
**UbicaciÃ³n:** `expert_bot_api_COPY/app/energy_service.py`

Cuando Energy IA API solicita contexto de un usuario nuevo:

```python
# Si no existe perfil, se crea automÃ¡ticamente
if not profile_data:
    logger.info(f"Perfil no encontrado para {user_id}, creando perfil mÃ­nimo")
    minimal_profile = await _create_minimal_user_profile(user_id, firebase_user)

# ExtracciÃ³n del nombre real del displayName
user_name = firebase_user.display_name or "Usuario"

# Se almacena en el campo user_id (que contiene el nombre real)
```

#### **SincronizaciÃ³n de Datos:**

- âœ… **Firebase Firestore**: Datos de perfil y preferencias
- âœ… **BigQuery**: AnalÃ­tica y mÃ©tricas de uso
- âœ… **Tiempo Real**: SincronizaciÃ³n inmediata entre servicios

### **4ï¸âƒ£ MANEJO ROBUSTO DE ERRORES**

#### **Fallbacks Implementados:**

1. **ğŸ”„ Timeout de ComunicaciÃ³n:**

   ```python
   try:
       response = requests.get(url, timeout=5)
   except requests.exceptions.Timeout:
       return self._get_cached_context(user_token)
   ```

2. **ğŸŒ Error de ConexiÃ³n:**

   ```python
   except requests.exceptions.ConnectionError:
       logger.warning("Error de conexiÃ³n - modo offline")
       return self._get_empty_context()
   ```

3. **ğŸ‘¤ Usuario Sin Perfil:**

   ```python
   # Expert Bot API crea automÃ¡ticamente perfil mÃ­nimo
   if not user_profile:
       minimal_profile = create_minimal_user_profile(user_id)
   ```

### **5ï¸âƒ£ AUTENTICACIÃ“N ENTRE SERVICIOS**

#### **Token Forwarding:**

```python
# Energy IA API reenvÃ­a token del usuario
headers = {"Authorization": f"Bearer {user_token}"}

# Expert Bot API valida el mismo token

@token_required
def handle_cross_service_communication():
    # El decorador valida automÃ¡ticamente el token
```

#### **ValidaciÃ³n de Origen:**

```python
# Verificar que la peticiÃ³n viene de Energy IA API
if source != "energy_ia_api":
    raise AppError("Fuente no autorizada para este endpoint", 403)
```

### **6ï¸âƒ£ LOGGING Y MONITORIZACIÃ“N**

#### **Logging Cross-Service:**

```python
# En Expert Bot API
logger.info(
    "ComunicaciÃ³n entre servicios recibida - Usuario: %s, Fuente: %s",
    user_id, source
)

# En Energy IA API
logger.info(
    "Obteniendo contexto de usuario desde expert-bot-api: %s",
    user_id
)
```

#### **MÃ©tricas a Monitorizar:**

- â±ï¸ **Latencia Cross-Service**: Tiempo de respuesta entre servicios
- ğŸ“Š **Tasa de Ã‰xito**: % de comunicaciones exitosas
- ğŸ”„ **Uso de Fallbacks**: Frecuencia de uso de contextos cache/vacÃ­o
- ğŸ‘¥ **CreaciÃ³n de Perfiles**: Nuevos usuarios procesados automÃ¡ticamente

### **7ï¸âƒ£ CONFIGURACIÃ“N DE ENDPOINTS**

#### **Variables de Entorno CrÃ­ticas:**

```env
# En Energy IA API
EXPERT_BOT_API_URL=http://localhost:8080

# En Expert Bot API
ENERGY_IA_API_URL=http://localhost:8081

# URLs de producciÃ³n en Cloud Run
EXPERT_BOT_API_URL=https://expert-bot-api-service-url
ENERGY_IA_API_URL=https://energy-ia-api-service-url
```

### **8ï¸âƒ£ TESTING DE COMUNICACIÃ“N**

#### **VerificaciÃ³n de Conectividad:**

```python
# Test de comunicaciÃ³n bÃ¡sica
response = requests.get(f"{expert_bot_url}/api/v1/health")
assert response.status_code == 200

# Test de cross-service con usuario real
response = requests.post(
    f"{expert_bot_url}/api/v1/chat/cross-service",
    headers={"Authorization": f"Bearer {valid_token}"},
    json={"message": "test", "user_id": "test_user", "source": "energy_ia_api"}
)
assert response.status_code == 200
```

### **9ï¸âƒ£ VENTAJAS DE LA ARQUITECTURA**

- ğŸ¯ **SeparaciÃ³n de Responsabilidades**: Cada servicio tiene su especializaciÃ³n
- ğŸ”„ **Escalabilidad Independiente**: Los servicios pueden escalar por separado
- ğŸ›¡ï¸ **Robustez**: Fallbacks automÃ¡ticos ante fallos de comunicaciÃ³n
- ğŸ“Š **Trazabilidad**: Logging completo de comunicaciones inter-servicio
- âš¡ **Performance**: Auto-creaciÃ³n de perfiles reduce llamadas repetitivas
