# âš¡ DOCUMENTACIÃ“N COMPLETA - ENERGY IA API

## ğŸ“‹ **INFORMACIÃ“N GENERAL**

**Nombre del Microservicio:** Energy IA API  
**VersiÃ³n:** 2025.1.0 - EMPRESARIAL COPY  
**Puerto:** 8081  
**TecnologÃ­a:** Flask + Python 3.10+  
**Base de Datos:** Firebase Firestore + BigQuery  
**AutenticaciÃ³n:** Firebase Admin SDK + JWT  
**EspecializaciÃ³n:** AnÃ¡lisis energÃ©tico, gestiÃ³n de tarifas, chatbot IA

---

## ğŸ“ **ESTRUCTURA COMPLETA DE ARCHIVOS**

```
energy_ia_api_COPY/
â”‚
â”œâ”€â”€ ğŸ“„ ARCHIVOS DE CONFIGURACIÃ“N
â”‚   â”œâ”€â”€ .env                     # Variables de entorno (SENSIBLE)
â”‚   â”œâ”€â”€ .firebaserc             # ConfiguraciÃ³n especÃ­fica de Firebase
â”‚   â”œâ”€â”€ .dockerignore           # Archivos ignorados por Docker
â”‚   â”œâ”€â”€ Dockerfile              # ConfiguraciÃ³n de contenedor Docker
â”‚   â”œâ”€â”€ pyproject.toml          # ConfiguraciÃ³n del proyecto Python
â”‚   â”œâ”€â”€ requirements-base.txt   # Dependencias base del proyecto
â”‚   â”œâ”€â”€ requirements-dev.txt    # Dependencias de desarrollo
â”‚   â”œâ”€â”€ requirements-ml.txt     # Dependencias de Machine Learning IA
â”‚   â”œâ”€â”€ requirements.txt        # TODAS las dependencias
â”‚   â””â”€â”€ run.py                  # ğŸš€ ARCHIVO PRINCIPAL DE EJECUCIÃ“N
â”‚
â”œâ”€â”€ ğŸ“¦ app/ - NÃšCLEO DE LA APLICACIÃ“N
â”‚   â”œâ”€â”€ __init__.py             # âš™ï¸ Inicializador de la aplicaciÃ³n Flask
â”‚   â”œâ”€â”€ config.py               # ğŸ”§ Configuraciones por entorno
â”‚   â”‚
â”‚   â”œâ”€â”€ ğŸ›£ï¸ RUTAS PRINCIPALES
â”‚   â”œâ”€â”€ routes.py               # âš¡ Endpoints energÃ©ticos + ADMIN tarifas
â”‚   â”œâ”€â”€ chatbot_routes.py       # ğŸ¤– Endpoints del chatbot IA
â”‚   â””â”€â”€ links_routes.py         # ğŸ”— GestiÃ³n de enlaces especÃ­ficos
â”‚   â”‚
â”‚   â”œâ”€â”€ ğŸ”§ SERVICIOS ESPECIALIZADOS
â”‚   â””â”€â”€ services/               # ğŸ“ Servicios de anÃ¡lisis energÃ©tico
â”‚       â”œâ”€â”€ analysis_service.py # ğŸ“Š AnÃ¡lisis de consumo energÃ©tico
â”‚       â”œâ”€â”€ chatbot_service.py  # ğŸ¤– LÃ³gica del chatbot IA
â”‚       â”œâ”€â”€ billing_service.py  # ğŸ’° Servicios de facturaciÃ³n
â”‚       â”œâ”€â”€ tariff_service.py   # âš¡ GestiÃ³n de tarifas energÃ©ticas
â”‚       â””â”€â”€ recommendation_service.py # ğŸ’¡ Sistema de recomendaciones
â”‚
â”œâ”€â”€ ğŸ” smarwatt_auth/ - SISTEMA DE AUTENTICACIÃ“N
â”‚   â”œâ”€â”€ __init__.py            # Inicializador del mÃ³dulo de auth
â”‚   â”œâ”€â”€ auth.py                # ğŸ›¡ï¸ Decoradores y lÃ³gica de autenticaciÃ³n
â”‚   â””â”€â”€ smarwatt_auth/         # ğŸ“ SubmÃ³dulo de autenticaciÃ³n legacy
â”‚       â””â”€â”€ auth.py            # ğŸ”„ ImplementaciÃ³n alternativa de auth
â”‚
â”œâ”€â”€ ğŸ› ï¸ utils/ - UTILIDADES ESPECIALIZADAS
â”‚   â”œâ”€â”€ __init__.py            # Inicializador de utilidades
â”‚   â”œâ”€â”€ data_processors.py     # ğŸ“Š Procesadores de datos energÃ©ticos
â”‚   â”œâ”€â”€ ml_models.py           # ğŸ§  Modelos de Machine Learning
â”‚   â””â”€â”€ esios_client.py        # ğŸŒ Cliente para API de ESIOS (precios energÃ­a)
â”‚
â”œâ”€â”€ ğŸ“Š logs/ - ARCHIVOS DE LOG
â”‚   â””â”€â”€ energy_ia_api.log      # Logs especÃ­ficos del servicio energÃ©tico
â”‚
â””â”€â”€ ğŸ³ ARCHIVOS DOCKER Y CACHE
    â””â”€â”€ __pycache__/           # Cache de Python (auto-generado)
```

---

## âš™ï¸ **COMPONENTES PRINCIPALES**

### 1ï¸âƒ£ **run.py - EJECUTOR PRINCIPAL**

**UbicaciÃ³n:** `energy_ia_api_COPY/run.py`

**FunciÃ³n:** Punto de entrada principal especializado en servicios energÃ©ticos

**CaracterÃ­sticas Empresariales:**

- âœ… ConfiguraciÃ³n logging empresarial especÃ­fico para energÃ­a
- âœ… InicializaciÃ³n con modo empresarial
- âœ… ConfiguraciÃ³n de variables especÃ­ficas de energÃ­a
- âœ… IntegraciÃ³n con APIs externas (ESIOS)
- âœ… MonitorizaciÃ³n de servicios energÃ©ticos

**ConfiguraciÃ³n Especializada:**

```python
# Variables especÃ­ficas de energÃ­a
app.config["ENTERPRISE_MODE"] = True
app.config["API_VERSION"] = "2025.1.0"
app.config["ENERGY_SPECIALIZATION"] = True
app.config["ESIOS_INTEGRATION"] = True
```

### 2ï¸âƒ£ **app/**init**.py - INICIALIZADOR ENERGÃ‰TICO**

**UbicaciÃ³n:** `energy_ia_api_COPY/app/__init__.py`

**FunciÃ³n:** ConfiguraciÃ³n especializada para servicios energÃ©ticos

**Componentes EspecÃ­ficos:**

- âš¡ **IntegraciÃ³n con APIs energÃ©ticas externas**
- ğŸ¤– **ConfiguraciÃ³n especÃ­fica para chatbot IA**
- ğŸ“Š **ConexiÃ³n con datos de mercado energÃ©tico**
- ğŸ’° **IntegraciÃ³n con sistemas de facturaciÃ³n**

**Blueprints Especializados:**

```python
# Registro de rutas energÃ©ticas
app.register_blueprint(energy_routes_bp, url_prefix="/api/v1/energy")
app.register_blueprint(chatbot_bp, url_prefix="/api/v1/chatbot")
app.register_blueprint(links_bp, url_prefix="/api/v1/links")
```

### 3ï¸âƒ£ **config.py - CONFIGURACIONES ENERGÃ‰TICAS**

**UbicaciÃ³n:** `energy_ia_api_COPY/app/config.py`

**Configuraciones EspecÃ­ficas:**

- âš¡ **APIs de mercado energÃ©tico (ESIOS)**
- ğŸ“Š **Tablas BigQuery especÃ­ficas de energÃ­a**
- ğŸ’° **ConfiguraciÃ³n de sistemas de facturaciÃ³n**
- ğŸ¤– **ParÃ¡metros del chatbot IA**

---

## ğŸ›£ï¸ **DOCUMENTACIÃ“N DE RUTAS ESPECIALIZADAS**

### 1ï¸âƒ£ **routes.py - SERVICIOS ENERGÃ‰TICOS + ADMIN**

**Prefijo:** `/api/v1/energy`

#### **ENDPOINTS PÃšBLICOS DE ENERGÃA:**

| Endpoint                | MÃ©todo | Auth    | FunciÃ³n                                           |
| ----------------------- | ------ | ------- | ------------------------------------------------- |
| `/tariffs/search`       | GET    | PÃºblico | `search_tariffs()` - Buscar tarifas disponibles   |
| `/tariffs/compare`      | POST   | PÃºblico | `compare_tariffs()` - Comparar tarifas            |
| `/consumption/estimate` | POST   | PÃºblico | `estimate_consumption()` - Estimar consumo        |
| `/market/prices`        | GET    | PÃºblico | `get_market_prices()` - Precios de mercado actual |

#### **ENDPOINTS ADMINISTRATIVOS DE TARIFAS:**

| Endpoint                   | MÃ©todo | Auth     | FunciÃ³n                                            |
| -------------------------- | ------ | -------- | -------------------------------------------------- |
| `/admin/tariffs/add`       | POST   | ğŸ¢ Admin | `add_tariff_data()` - **AÃ±adir tarifa individual** |
| `/admin/tariffs/batch-add` | POST   | ğŸ¢ Admin | `batch_add_tariffs()` - **AÃ±adir tarifas en lote** |

#### **ENDPOINTS DE USUARIO AUTENTICADO:**

| Endpoint                | MÃ©todo | Auth     | FunciÃ³n                                                       |
| ----------------------- | ------ | -------- | ------------------------------------------------------------- |
| `/user/profile`         | GET    | ğŸ”’ Token | `get_user_energy_profile()` - Perfil energÃ©tico               |
| `/user/consumption`     | GET    | ğŸ”’ Token | `get_user_consumption()` - Historial de consumo               |
| `/user/bills`           | GET    | ğŸ”’ Token | `get_user_bills()` - Facturas del usuario                     |
| `/user/recommendations` | GET    | ğŸ”’ Token | `get_user_recommendations()` - Recomendaciones personalizadas |

### 2ï¸âƒ£ **chatbot_routes.py - CHATBOT IA ESPECIALIZADO**

**Prefijo:** `/api/v1/chatbot`

| Endpoint   | MÃ©todo | Auth     | FunciÃ³n                                                    |
| ---------- | ------ | -------- | ---------------------------------------------------------- |
| `/chat`    | POST   | ğŸ”’ Token | `chat_endpoint()` - **ConversaciÃ³n principal del chatbot** |
| `/context` | GET    | ğŸ”’ Token | `get_chat_context()` - Contexto de conversaciÃ³n            |
| `/history` | GET    | ğŸ”’ Token | `get_chat_history()` - Historial de conversaciones         |

#### **FLUJO DEL CHATBOT IA:**

```python
1. RecepciÃ³n del mensaje del usuario
2. ObtenciÃ³n del contexto del usuario desde expert-bot-api
3. AnÃ¡lisis del mensaje con IA especializada en energÃ­a
4. GeneraciÃ³n de respuesta personalizada
5. ActualizaciÃ³n del contexto de conversaciÃ³n
6. Retorno de respuesta con datos energÃ©ticos relevantes
```

### 3ï¸âƒ£ **links_routes.py - ENLACES ENERGÃ‰TICOS**

**Prefijo:** `/api/v1/links`

| Endpoint                       | MÃ©todo | Auth    | FunciÃ³n                                              |
| ------------------------------ | ------ | ------- | ---------------------------------------------------- |
| `/energy-report/<link_id>`     | GET    | PÃºblico | `get_energy_report()` - Reportes energÃ©ticos         |
| `/tariff-comparison/<link_id>` | GET    | PÃºblico | `get_tariff_comparison()` - Comparaciones de tarifas |

---

## ğŸ”§ **SERVICIOS ESPECIALIZADOS EN ENERGÃA**

### 1ï¸âƒ£ **services/analysis_service.py - ANÃLISIS ENERGÃ‰TICO**

**Funciones Principales:**

- ğŸ“Š `analyze_consumption_patterns()` - AnÃ¡lisis de patrones de consumo
- ğŸ“ˆ `calculate_efficiency_metrics()` - MÃ©tricas de eficiencia
- ğŸ’° `estimate_savings()` - EstimaciÃ³n de ahorros
- ğŸ“‰ `detect_anomalies()` - DetecciÃ³n de anomalÃ­as en consumo

**Algoritmos Implementados:**

- ğŸ§® AnÃ¡lisis de series temporales para consumo
- ğŸ“Š Clustering de patrones de uso
- ğŸ” DetecciÃ³n de outliers
- ğŸ“ˆ PredicciÃ³n de consumo futuro

### 2ï¸âƒ£ **services/chatbot_service.py - IA CONVERSACIONAL**

**Funciones Principales:**

- ğŸ¤– `process_user_message()` - Procesamiento de mensajes
- ğŸ§  `generate_ai_response()` - GeneraciÃ³n de respuestas IA
- ğŸ’¬ `maintain_conversation_context()` - Contexto conversacional
- ğŸ“Š `extract_energy_intent()` - ExtracciÃ³n de intenciones energÃ©ticas

**Capacidades del Chatbot:**

- ğŸ’¡ Recomendaciones de ahorro energÃ©tico
- ğŸ“Š ExplicaciÃ³n de facturas y consumos
- âš¡ InformaciÃ³n sobre tarifas
- ğŸ  Consejos de eficiencia domÃ©stica

### 3ï¸âƒ£ **services/billing_service.py - FACTURACIÃ“N**

**Funciones Principales:**

- ğŸ’° `calculate_bill_estimate()` - EstimaciÃ³n de facturas
- ğŸ“„ `parse_bill_data()` - AnÃ¡lisis de facturas subidas
- ğŸ“Š `generate_consumption_report()` - Reportes de consumo
- ğŸ’¸ `calculate_potential_savings()` - CÃ¡lculo de ahorros potenciales

### 4ï¸âƒ£ **services/tariff_service.py - GESTIÃ“N DE TARIFAS**

**Funciones Principales:**

- âš¡ `get_available_tariffs()` - Tarifas disponibles
- ğŸ” `find_best_tariff()` - BÃºsqueda de mejor tarifa
- ğŸ“Š `compare_tariff_costs()` - ComparaciÃ³n de costos
- ğŸ·ï¸ `validate_tariff_data()` - ValidaciÃ³n de datos de tarifas

**IntegraciÃ³n con Fuentes Externas:**

- ğŸŒ **ESIOS API** - Precios oficiales del mercado
- ğŸ“Š **BigQuery** - Historial de tarifas
- ğŸ”„ **Actualizaciones automÃ¡ticas** de precios

### 5ï¸âƒ£ **services/recommendation_service.py - RECOMENDACIONES IA**

**Funciones Principales:**

- ğŸ’¡ `generate_personalized_recommendations()` - Recomendaciones personalizadas
- ğŸ  `analyze_home_efficiency()` - AnÃ¡lisis de eficiencia del hogar
- ğŸ“± `suggest_usage_optimizations()` - Optimizaciones de uso
- ğŸ’° `calculate_roi_improvements()` - ROI de mejoras

---

## ğŸ” **SISTEMA DE AUTENTICACIÃ“N ENERGÃ‰TICO**

### **Decoradores Especializados:**

- ğŸ”’ `@token_required` - AutenticaciÃ³n bÃ¡sica
- ğŸ¢ `@admin_required` - **Acceso administrativo para gestiÃ³n de tarifas**
- âš¡ `@energy_user_required` - Usuario con perfil energÃ©tico

### **Flujo de AutenticaciÃ³n para Tarifas Admin:**

```python
1. VerificaciÃ³n del token de administrador
2. ValidaciÃ³n del rol 'admin'
3. VerificaciÃ³n de permisos de gestiÃ³n de tarifas
4. Establecimiento de contexto administrativo
5. Logging de actividad administrativa
```

---

## ğŸ’¾ **INTEGRACIÃ“N CON BASES DE DATOS ENERGÃ‰TICAS**

### **Firebase Firestore - Colecciones EnergÃ©ticas:**

- âš¡ `energy_profiles` - Perfiles energÃ©ticos de usuarios
- ğŸ’° `user_bills` - Facturas procesadas
- ğŸ  `consumption_data` - Datos de consumo
- ğŸ’¬ `chat_conversations` - Conversaciones del chatbot

### **BigQuery - Tablas EnergÃ©ticas:**

- âš¡ `market_tariffs` - **Tarifas del mercado energÃ©tico**
- ğŸ“Š `consumption_analytics` - AnalÃ­tica de consumo
- ğŸ’° `billing_data` - Datos de facturaciÃ³n
- ğŸ¤– `chatbot_interactions` - Interacciones del chatbot
- ğŸ“„ `uploaded_documents_log` - **Log de documentos subidos**

---

## ğŸ¤– **FUNCIONALIDAD DEL CHATBOT IA**

### **Capacidades Principales:**

1. **ğŸ  AnÃ¡lisis de Facturas:**

   - Procesamiento automÃ¡tico de PDFs
   - ExtracciÃ³n de datos de consumo
   - IdentificaciÃ³n de patrones de gasto

2. **ğŸ’¡ Recomendaciones Personalizadas:**

   - AnÃ¡lisis del perfil del usuario
   - Sugerencias de ahorro especÃ­ficas
   - ComparaciÃ³n con usuarios similares

3. **âš¡ InformaciÃ³n de Tarifas:**

   - ExplicaciÃ³n de diferentes tipos de tarifa
   - CÃ¡lculo de ahorros por cambio de tarifa
   - Alertas de mejores ofertas

4. **ğŸ“Š MonitorizaciÃ³n de Consumo:**
   - Seguimiento de tendencias
   - Alertas de consumo anÃ³malo
   - Predicciones de facturas futuras

### **Flujo de ConversaciÃ³n:**

```python
Usuario: "Â¿Por quÃ© mi factura de luz es tan alta este mes?"

Chatbot IA:
1. Analiza el perfil energÃ©tico del usuario
2. Revisa facturas anteriores
3. Identifica incrementos de consumo
4. Compara con patrones estacionales
5. Genera respuesta personalizada con:
   - Causas probables del incremento
   - Recomendaciones especÃ­ficas de ahorro
   - ComparaciÃ³n con tarifa actual vs. alternativas
   - Consejos de eficiencia energÃ©tica
```

---

## ğŸ¢ **FUNCIONALIDAD ADMINISTRATIVA DE TARIFAS**

### **1. AÃ±adir Tarifa Individual (`/admin/tariffs/add`):**

**CaracterÃ­sticas:**

- âœ… ValidaciÃ³n robusta de datos
- âœ… PrevenciÃ³n de duplicados
- âœ… Mapeo automÃ¡tico de campos
- âœ… Logging de actividad administrativa
- âœ… Respuesta detallada con estadÃ­sticas

**Campos Procesados:**

```python
{
    "provider_name": "Nombre del proveedor",
    "tariff_name": "Nombre de la tarifa",
    "tariff_type": "regulated|free_market|pvpc",
    "fixed_monthly_fee": 25.50,
    "kwh_price_flat": 0.085,
    "kwh_price_peak": 0.095,
    "kwh_price_valley": 0.075,
    "power_price_per_kw_per_month": 3.45,
    "is_pvpc": false,
    "is_active": true
}
```

### **2. AÃ±adir Tarifas en Lote (`/admin/tariffs/batch-add`):**

**CaracterÃ­sticas:**

- ğŸ“¦ Procesamiento masivo de tarifas
- ğŸ” ValidaciÃ³n individual por tarifa
- ğŸ“Š EstadÃ­sticas detalladas de procesamiento
- ğŸ›¡ï¸ Manejo robusto de errores
- ğŸ“ Logging completo de operaciones

**EstadÃ­sticas de Respuesta:**

```json
{
  "statistics": {
    "total_processed": 20,
    "successfully_inserted": 15,
    "duplicates_prevented": 3,
    "validation_errors_handled": 2
  }
}
```

---

## ğŸŒ **INTEGRACIÃ“N CON APIS EXTERNAS**

### **1. ESIOS API (Operador del Sistema ElÃ©ctrico EspaÃ±ol):**

- ğŸ“Š Precios horarios del mercado
- âš¡ Precios PVPC oficiales
- ğŸ“ˆ Datos de demanda elÃ©ctrica
- ğŸŒ InformaciÃ³n de renovables

### **2. ComunicaciÃ³n con Expert Bot API:**

- ğŸ”„ Cross-service requests para contexto de usuario
- ğŸ“Š SincronizaciÃ³n de perfiles energÃ©ticos
- ğŸ’¬ Intercambio de datos de conversaciÃ³n

---

## ğŸš€ **INSTRUCCIONES DE DESPLIEGUE ENERGÃ‰TICO**

### **1. ConfiguraciÃ³n EspecÃ­fica de EnergÃ­a:**

```env
# APIs externas de energÃ­a
ESIOS_API_TOKEN=your-esios-token
ENERGY_MARKET_API_URL=https://api.esios.ree.es

# ConfiguraciÃ³n BigQuery energÃ©tica
BQ_MARKET_TARIFFS_TABLE_ID=market_tariffs
BQ_CONSUMPTION_TABLE_ID=consumption_analytics
BQ_BILLING_TABLE_ID=billing_data

# ConfiguraciÃ³n del chatbot IA
CHATBOT_MODEL=gpt-4-energy-specialist
CHATBOT_CONTEXT_WINDOW=8192
AI_RESPONSE_MAX_LENGTH=1000
```

### **2. EjecuciÃ³n con Servicios EnergÃ©ticos:**

```bash
# Verificar conexiÃ³n con APIs energÃ©ticas
python utils/test_esios_connection.py

# Ejecutar con modo energÃ©tico
export ENERGY_MODE=true
python run.py
```

---

## ğŸ› ï¸ **MANTENIMIENTO ESPECÃFICO DE ENERGÃA**

### **Tareas de Mantenimiento Regulares:**

1. **ğŸ”„ ActualizaciÃ³n de Tarifas:**

   - Ejecutar script de actualizaciÃ³n diaria
   - Verificar nuevas tarifas de proveedores
   - Validar precios PVPC

2. **ğŸ“Š AnÃ¡lisis de Calidad de Datos:**

   - Verificar consistencia de datos de consumo
   - Validar cÃ¡lculos de facturaciÃ³n
   - Revisar anomalÃ­as en patrones

3. **ğŸ¤– OptimizaciÃ³n del Chatbot:**
   - Revisar precisiÃ³n de respuestas
   - Actualizar base de conocimiento energÃ©tico
   - Ajustar algoritmos de recomendaciÃ³n

### **MÃ©tricas EspecÃ­ficas a Monitorizar:**

- âš¡ **PrecisiÃ³n de CÃ¡lculos:** Exactitud en estimaciones de ahorro
- ğŸ¤– **SatisfacciÃ³n del Chatbot:** Rating de utilidad de respuestas
- ğŸ“Š **Calidad de Datos:** Completitud de perfiles energÃ©ticos
- ğŸ”„ **SincronizaciÃ³n:** Tiempo de respuesta cross-service

---

## ğŸ› **SOLUCIÃ“N DE PROBLEMAS ENERGÃ‰TICOS**

### **1. Error en CÃ¡lculos de Tarifas:**

```
Error: Precios PVPC no disponibles
SoluciÃ³n: Verificar conexiÃ³n con ESIOS API
```

### **2. Chatbot No Responde Adecuadamente:**

```
Error: Contexto de usuario incompleto
SoluciÃ³n: Verificar comunicaciÃ³n con expert-bot-api
```

### **3. Datos de Consumo Inconsistentes:**

```
Error: AnomalÃ­as en patrones de consumo
SoluciÃ³n: Ejecutar script de validaciÃ³n de datos
```

---

## ğŸ“ˆ **ROADMAP ENERGÃ‰TICO**

### **VersiÃ³n 2025.2.0:**

- ğŸŒ IntegraciÃ³n con datos de energÃ­a solar
- ğŸ”‹ Soporte para almacenamiento energÃ©tico
- ğŸ“± OptimizaciÃ³n para dispositivos IoT

### **VersiÃ³n 2025.3.0:**

- ğŸŒ ExpansiÃ³n a mercados energÃ©ticos europeos
- ğŸ§  IA predictiva para precios de energÃ­a
- ğŸ­ Soporte para consumidores industriales

### **VersiÃ³n 2026.1.0:**

- âš¡ GestiÃ³n de vehÃ­culos elÃ©ctricos
- ğŸ  Smart home automation
- ğŸŒ Blockchain para trading energÃ©tico

---

## ğŸ”— **COMUNICACIÃ“N CON EXPERT BOT API**

### **ARQUITECTURA DE COMUNICACIÃ“N ENERGÃ‰TICA**

El Energy IA API se especializa en **conversaciones inteligentes sobre energÃ­a** y colabora estrechamente con Expert Bot API para obtener **contexto completo del usuario** y gestionar **perfiles energÃ©ticos**.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     â”‚  Cross  â”‚                     â”‚
â”‚   ENERGY IA API     â”‚ Service â”‚   EXPERT BOT API    â”‚
â”‚   (Chatbot IA)      â”‚ â”€â”€â”€â”€â”€â”€â–º â”‚   (User Context)    â”‚
â”‚   Puerto 8081       â”‚ Request â”‚   Puerto 8080       â”‚
â”‚                     â”‚         â”‚                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  ğŸ¤– Especialista IA              ğŸ“Š Gestor de Perfiles
  ğŸ—£ï¸ Conversaciones               ğŸ‘¤ Datos de Usuario
  âš¡ AnÃ¡lisis EnergÃ©tico           ğŸ’¾ Firebase/BigQuery
```

### **1ï¸âƒ£ FLUJO DE COMUNICACIÃ“N CHATBOT**

#### **Endpoint Principal del Chatbot**

**Endpoint:** `POST /api/v1/chatbot/chat`  
**UbicaciÃ³n:** `energy_ia_api_COPY/app/chatbot_routes.py`

#### **Proceso de ConversaciÃ³n Completo:**

1. **ğŸ‘¤ Usuario envÃ­a mensaje** al chatbot de Energy IA API
2. **ğŸ” ValidaciÃ³n de autenticaciÃ³n** con token del usuario
3. **ğŸ“ Solicitud de contexto** a Expert Bot API:

   ```python
   # Energy IA API solicita contexto del usuario
   def get_user_context_robust(self, user_token: str) -> Dict[str, Any]:
       headers = {"Authorization": f"Bearer {user_token}"}
       response = requests.get(
           f"{self.expert_bot_url}/api/v1/energy/users/profile",
           headers=headers,
           timeout=5
       )
   ```

4. **ğŸ¢ Expert Bot API responde** con contexto enriquecido:

   ```json
   {
     "user_name": "Juan",
     "home_type": "apartment",
     "num_inhabitants": 3,
     "consumption_kwh": 350,
     "has_solar_panels": false,
     "heating_type": "gas",
     "post_code_prefix": "28"
   }
   ```

5. **ğŸ¤– GeneraciÃ³n de respuesta IA** personalizada:

   ```python
   # Procesamiento con contexto energÃ©tico
   ai_response = self.chat_service.generate_contextual_response(
       message=user_message,
       user_context=user_context,
       conversation_history=conversation_history
   )
   ```

6. **ğŸ“¤ Respuesta final** al usuario con personalizaciÃ³n completa

### **2ï¸âƒ£ GESTIÃ“N ROBUSTA DE CONTEXTO**

#### **Clase EnterpriseChatbotService**

**UbicaciÃ³n:** `energy_ia_api_COPY/app/chatbot_routes.py`

**CaracterÃ­sticas Principales:**

- ğŸ”„ **Fallbacks automÃ¡ticos** ante errores de comunicaciÃ³n
- â±ï¸ **Timeouts configurables** para evitar bloqueos
- ğŸ’¾ **Cache de contexto** para usuarios frecuentes
- ğŸ›¡ï¸ **Modo offline** cuando Expert Bot API no estÃ¡ disponible

#### **Fallback Strategy:**

```python
def get_user_context_robust(self, user_token: str, timeout: int = 5):
    try:
        # 1. Intentar obtener contexto completo
        response = requests.get(expert_bot_url, headers=headers, timeout=timeout)
        if response.status_code == 200:
            return self._process_user_context(response.json())

        # 2. Si falla, usar contexto vacÃ­o (auto-creaciÃ³n activada)
        else:
            return self._get_empty_context()

    except requests.exceptions.Timeout:
        # 3. Timeout: usar contexto cacheado
        return self._get_cached_context(user_token)

    except requests.exceptions.ConnectionError:
        # 4. Sin conexiÃ³n: modo offline
        return self._get_empty_context()
```

### **3ï¸âƒ£ PROCESAMIENTO DE CONTEXTO ENERGÃ‰TICO**

#### **ExtracciÃ³n de Nombre del Usuario:**

```python
def _process_user_context(self, profile_data: Dict) -> Dict[str, Any]:
    # USAR user_id como nombre real del usuario
    user_name = profile_data.get("user_id", "").strip()

    # Contexto energÃ©tico completo
    context = {
        "user_name": user_name,  # ğŸ‘¤ Nombre para personalizaciÃ³n
        "has_complete_data": bool(profile_data.get("consumption_kwh")),
        "home_type": profile_data.get("home_type", ""),
        "num_inhabitants": profile_data.get("num_inhabitants", 0),
        "heating_type": profile_data.get("heating_type", ""),
        "has_ac": profile_data.get("has_ac", False),
        "has_solar_panels": profile_data.get("has_solar_panels", False),
        "monthly_consumption": profile_data.get("monthly_consumption_kwh", 0)
    }
    return context
```

### **4ï¸âƒ£ INTEGRACIÃ“N CON IA CONVERSACIONAL**

#### **Servicio de Chat Generativo**

**UbicaciÃ³n:** `energy_ia_api_COPY/app/services/generative_chat_service.py`

**PersonalizaciÃ³n de Respuestas:**

```python
# El chatbot usa el contexto para personalizar respuestas
user_context = get_user_context_robust(user_token)

ai_prompt = f"""
Usuario: {user_context['user_name']}
Tipo de vivienda: {user_context['home_type']}
Consumo mensual: {user_context['monthly_consumption']} kWh
Pregunta: {user_message}

Responde de forma personalizada y especÃ­fica para su situaciÃ³n energÃ©tica.
"""

response = generative_ai.generate_response(ai_prompt)
```

#### **Capacidades de PersonalizaciÃ³n:**

- ğŸ  **AnÃ¡lisis especÃ­fico** por tipo de vivienda
- ğŸ“Š **Recomendaciones basadas** en consumo real
- ğŸ’° **CÃ¡lculos de ahorro** personalizados
- âš¡ **Comparaciones de tarifas** segÃºn perfil

### **5ï¸âƒ£ COMUNICACIÃ“N CROSS-SERVICE AVANZADA**

#### **Expert Bot API - Endpoint Receptor**

**Endpoint:** `POST /api/v1/chat/cross-service`

Cuando Energy IA API necesita procesamiento avanzado:

```python
# Energy IA API envÃ­a mensaje para procesamiento
cross_service_request = {
    "message": "Analiza mi consumo y recomienda la mejor tarifa",
    "user_id": user_id,
    "source": "energy_ia_api",
    "conversation_context": {
        "topic": "tariff_optimization",
        "user_preferences": user_preferences
    }
}

response = requests.post(
    f"{expert_bot_url}/api/v1/chat/cross-service",
    headers={"Authorization": f"Bearer {user_token}"},
    json=cross_service_request
)
```

#### **Procesamiento en Expert Bot API:**

- ğŸ“Š **AnÃ¡lisis de datos** en BigQuery
- ğŸ” **Consultas complejas** de tarifas
- ğŸ’¡ **Algoritmos de optimizaciÃ³n** energÃ©tica
- ğŸ“ˆ **GeneraciÃ³n de reportes** detallados

### **6ï¸âƒ£ CONFIGURACIÃ“N DE COMUNICACIÃ“N**

#### **Variables de Entorno CrÃ­ticas:**

```env
# URL del Expert Bot API
EXPERT_BOT_API_URL=http://localhost:8080
# En producciÃ³n: https://expert-bot-api-service-url

# Timeouts de comunicaciÃ³n
CROSS_SERVICE_TIMEOUT=5
CONNECTION_RETRY_ATTEMPTS=3

# Cache de contexto
CONTEXT_CACHE_TTL=300  # 5 minutos
ENABLE_CONTEXT_CACHE=true
```

#### **ConfiguraciÃ³n en chatbot_routes.py:**

```python
self.expert_bot_url = current_app.config.get(
    "EXPERT_BOT_API_URL",
    "http://localhost:8081"  # Fallback local
)
```

### **7ï¸âƒ£ LOGGING Y MONITORIZACIÃ“N DE COMUNICACIÃ“N**

#### **Logging Detallado:**

```python
# Logging de peticiones cross-service
logger.info(f"ğŸ”„ Obteniendo contexto de usuario desde expert-bot-api: {user_id}")
logger.info(f"â±ï¸ Tiempo de respuesta cross-service: {response_time}ms")
logger.warning(f"âš ï¸ Fallback activado para usuario: {user_id}")
```

#### **MÃ©tricas de ComunicaciÃ³n:**

- â±ï¸ **Latencia media** de solicitudes cross-service
- ğŸ“Š **Tasa de Ã©xito** de comunicaciÃ³n entre servicios
- ğŸ”„ **Frecuencia de fallbacks** utilizados
- ğŸ‘¥ **Usuarios con contexto completo** vs. contexto vacÃ­o

### **8ï¸âƒ£ VENTAJAS DE LA INTEGRACIÃ“N**

#### **Para el Usuario:**

- ğŸ¤– **Respuestas personalizadas** con su nombre real
- ğŸ“Š **AnÃ¡lisis especÃ­ficos** basados en su perfil
- ğŸ’° **Recomendaciones precisas** segÃºn su consumo
- ğŸ  **Consejos adaptados** a su tipo de vivienda

#### **Para el Sistema:**

- ğŸ”„ **Auto-creaciÃ³n** de perfiles faltantes
- ğŸ›¡ï¸ **Robustez** ante fallos de comunicaciÃ³n
- ğŸ“ˆ **Escalabilidad** independiente de servicios
- ğŸ¯ **EspecializaciÃ³n** de cada microservicio

### **9ï¸âƒ£ CASOS DE USO TÃPICOS**

#### **1. Usuario Nuevo (Sin Perfil):**

```
Usuario: "Hola, Â¿cÃ³mo puedo ahorrar en mi factura?"
â”Œâ”€ Energy IA API solicita contexto
â”œâ”€ Expert Bot API detecta: usuario sin perfil
â”œâ”€ Crea automÃ¡ticamente perfil mÃ­nimo
â”œâ”€ Extrae nombre de Firebase: "MarÃ­a"
â””â”€ Retorna contexto bÃ¡sico

Respuesta: "Hola MarÃ­a, para ayudarte a ahorrar..."
```

#### **2. Usuario con Perfil Completo:**

```
Usuario: "Â¿CuÃ¡nto ahorrarÃ­a con tarifa nocturna?"
â”Œâ”€ Energy IA API obtiene contexto completo
â”œâ”€ Expert Bot API retorna: consumo, horarios, tipo vivienda
â”œâ”€ Energy IA API calcula especÃ­ficamente
â””â”€ Respuesta personalizada con cÃ¡lculos reales

Respuesta: "Juan, con tu consumo de 400kWh/mes y tu patrÃ³n nocturno, ahorrarÃ­as 45â‚¬/mes..."
```

#### **3. AnÃ¡lisis Avanzado:**

```
Usuario: "Hazme un anÃ¡lisis completo de eficiencia"
â”Œâ”€ Energy IA API detecta: consulta compleja
â”œâ”€ EnvÃ­a cross-service request a Expert Bot API
â”œâ”€ Expert Bot API ejecuta anÃ¡lisis en BigQuery
â”œâ”€ Genera reporte completo con recomendaciones
â””â”€ Energy IA API presenta resultados conversacionalmente

Respuesta: "He analizado tu perfil completo, Ana. Tu eficiencia actual es..."
```

### **ğŸ”Ÿ TESTING DE INTEGRACIÃ“N**

#### **Tests Automatizados:**

```python
def test_cross_service_communication():
    # Test comunicaciÃ³n bÃ¡sica
    response = chatbot_service.get_user_context_robust(valid_token)
    assert response['user_name'] is not None

def test_fallback_behavior():
    # Test con Expert Bot API caÃ­do
    with mock_service_down():
        response = chatbot_service.get_user_context_robust(valid_token)
        assert response == chatbot_service._get_empty_context()
```

#### **MonitorizaciÃ³n en ProducciÃ³n:**

- ğŸ¥ **Health checks** entre servicios cada 30 segundos
- ğŸ“Š **Dashboards** de latencia cross-service
- ğŸš¨ **Alertas** cuando tasa de fallbacks > 10%
- ğŸ“ˆ **MÃ©tricas** de satisfacciÃ³n del usuario por calidad de respuesta
